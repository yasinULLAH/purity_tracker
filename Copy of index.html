<!DOCTYPE html>
<html lang="ur" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Yasin Ullah, Pakistan">
    <meta name="description"
        content="حنفی طہارت ٹریکر مسلم خواتین کو حنفی (دیوبند) فقہ کے اصولوں کے مطابق حیض، استحاضہ، نفاس، اور طہارت کے دنوں کو درست طریقے سے ٹریک اور شمار کرنے میں مدد کرتا ہے۔ یہ مقامی ڈیٹا سٹوریج کے لیے انڈیکسڈ ڈی بی کا استعمال کرتا ہے۔">
    <meta name="keywords"
        content="حنفی، فقہ، طہارت ٹریکر، حیض، استحاضہ، نفاس، طہارت، مسلم خواتین، انڈیکسڈ ڈی بی، دیوبند، اسلامی طہارت، نفاس ٹریکر، عادت، ایدہ، ٹریکر">
    <title>حنفی طہارت ٹریکر - اسلامی خواتین کی طہارت اور نفاس ٹریکنگ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .modal {
            display: none;
        }

        .modal.open {
            display: flex;
        }

        .info-box {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .info-box-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            z-index: 1000;
            width: 250px;
            right: 0;
            /* For RTL alignment */
            top: 100%;
            margin-top: 5px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            font-size: 0.875rem;
            text-align: right;
            line-height: 1.4;
        }

        .info-box:hover .info-box-content {
            display: block;
        }

        /* Adjust for RTL */
        .text-right {
            text-align: right;
        }

        input[type="number"],
        input[type="date"],
        input[type="time"] {
            direction: rtl;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans text-gray-900 min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-green-600 to-green-800 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold" id="appTitle">حنفی طہارت ٹریکر</h1>
            <nav class="flex items-center space-x-4">
                <button id="langToggleBtn"
                    class="bg-white text-green-700 px-3 py-1 rounded-full text-sm hover:bg-green-100 transition duration-300 ease-in-out">English</button>
                <button id="historyBtn"
                    class="bg-white text-green-700 px-4 py-2 rounded-full hover:bg-green-100 transition duration-300 ease-in-out">سائیکل ہسٹری</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 md:p-8">
        <section id="dashboard" class="bg-white p-6 rounded-lg shadow-xl mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-green-700 flex items-center" id="dashboardTitle">
                ڈیش بورڈ
                <span class="info-box mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-gray-700"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1  0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="info-box-content" id="dashboardInfo"></span>
                </span>
            </h2>
            <div id="statusDisplay"
                class="mb-6 p-4 bg-green-50 text-green-800 border-r-4 border-green-500 rounded-md text-lg">
                <p id="loadingStatus">حیثیت لوڈ ہو رہی ہے...</p>
            </div>
            <div id="habitDisplay"
                class="mb-6 p-4 bg-blue-50 text-blue-800 border-r-4 border-blue-500 rounded-md text-lg flex items-center">
                <p id="habitStatus">آپ کی عادت (عادہ): ابھی سیٹ نہیں ہوئی ہے۔</p>
                <span class="info-box mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-gray-700"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="info-box-content" id="habitInfo"></span>
                </span>
            </div>
            <button id="mainActionButton"
                class="w-full bg-green-600 text-white py-3 rounded-lg text-xl font-bold hover:bg-green-700 transition duration-300 ease-in-out"
                disabled>
                لوڈ ہو رہا ہے...
            </button>
            <button id="logNifasBtn"
                class="w-full mt-3 bg-purple-600 text-white py-3 rounded-lg text-xl font-bold hover:bg-purple-700 transition duration-300 ease-in-out hidden">نفاس لاگ کریں</button>
        </section>

        <section id="cycleHistorySection" class="bg-white p-6 rounded-lg shadow-xl mb-8 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-green-700" id="cycleHistoryTitle">سائیکل ہسٹری</h2>
            <div id="historyList" class="space-y-4">
                <p class="text-gray-600" id="noHistory">ابھی تک کوئی سائیکل ہسٹری دستیاب نہیں ہے۔</p>
            </div>
            <button id="backToDashboardBtn"
                class="mt-6 bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400 transition duration-300 ease-in-out">ڈیش بورڈ پر واپس</button>
        </section>
    </main>

    <footer class="bg-gray-800 text-white p-4 text-center text-sm mt-auto">
        <div class="container mx-auto">
            <p id="copyrightText">&copy; 2023 حنفی طہارت ٹریکر۔ تمام حقوق محفوظ ہیں۔</p>
            <p class="mt-2 text-gray-400" id="disclaimerText">
                یہ ایپلیکیشن ایک مفید ٹول کے طور پر ہے اور حنفی فقہ کے اصولوں پر مبنی ہے۔ یہ کسی مستند اسلامی اسکالر
                (مفتی) کی رہنمائی کا متبادل نہیں ہے۔ کسی بھی طبی مسئلے کے لیے، براہ کرم صحت کی دیکھ بھال کرنے والے ماہر
                سے مشورہ کریں۔
            </p>
            <div class="mt-2">
                <button id="exportDataBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-300 mr-2">ڈیٹا ایکسپورٹ کریں</button>
                <input type="file" id="importDataInput" accept=".json" class="hidden">
                <button id="importDataBtn"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md transition duration-300">ڈیٹا امپورٹ کریں</button>
            </div>
        </div>
    </footer>

    <!-- Modals -->

    <!-- Welcome Modal -->
    <div id="welcomeModal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-6 text-green-700" id="welcomeModalTitle">حنفی طہارت ٹریکر میں خوش آمدید!
            </h3>
            <p class="mb-6 text-lg flex items-center justify-center" id="welcomeQuestion">
                کیا آپ نے پہلے کبھی صحیح حیض کا تجربہ کیا ہے؟
                <span class="info-box mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-gray-700"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="info-box-content" id="welcomeInfo"></span>
                </span>
            </p>
            <div class="flex flex-col space-y-4">
                <button id="mubtadiahBtn"
                    class="bg-green-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition duration-300">نہیں،
                    یہ میرا پہلا موقع ہے۔</button>
                <button id="mutadahBtn"
                    class="bg-blue-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 transition duration-300">ہاں،
                    میری عادت ہے۔</button>
            </div>
        </div>
    </div>

    <!-- Mutadah Habit Input Modal -->
    <div id="mutadahHabitModal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full">
            <h3 class="text-2xl font-bold mb-6 text-green-700 flex items-center" id="habitModalTitle">
                اپنی عادات درج کریں
                <span class="info-box mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-gray-700"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="info-box-content" id="habitInputInfo"></span>
                </span>
            </h3>
            <div class="mb-4">
                <label for="haidhAdahDays" class="block text-gray-700 text-sm font-bold mb-2 flex items-center"
                    id="haidhAdahLabel">
                    آخری صحیح حیض کی مدت (دن):
                    <span class="info-box mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-gray-700"
                            viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                clip-rule="evenodd" />
                        </svg>
                        <span class="info-box-content" id="haidhAdahInfo"></span>
                    </span>
                </label>
                <input type="number" id="haidhAdahDays"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-right"
                    min="3" max="10" required>
            </div>
            <div class="mb-6">
                <label for="tuhrAdahDays" class="block text-gray-700 text-sm font-bold mb-2 flex items-center"
                    id="tuhrAdahLabel">
                    آخری صحیح طہارت کی مدت (دن):
                    <span class="info-box mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-gray-700"
                            viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                clip-rule="evenodd" />
                        </svg>
                        <span class="info-box-content" id="tuhrAdahInfo"></span>
                    </span>
                </label>
                <input type="number" id="tuhrAdahDays"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-right"
                    min="15" required>
            </div>
            <button id="saveMutadahHabitBtn"
                class="w-full bg-green-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition duration-300">عادات محفوظ کریں</button>
        </div>
    </div>

    <!-- Date/Time Picker Modal -->
    <div id="dateTimeModal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full">
            <h3 id="dateTimeModalTitle" class="text-2xl font-bold mb-6 text-green-700">تاریخ اور وقت منتخب کریں</h3>
            <div class="mb-4">
                <label for="datePicker" class="block text-gray-700 text-sm font-bold mb-2" id="dateLabel">تاریخ:</label>
                <input type="date" id="datePicker"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-right"
                    required>
            </div>
            <div class="mb-6">
                <label for="timePicker" class="block text-gray-700 text-sm font-bold mb-2" id="timeLabel">وقت:</label>
                <input type="time" id="timePicker"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-right"
                    required>
            </div>
            <button id="saveDateTimeBtn"
                class="w-full bg-green-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition duration-300">محفوظ کریں</button>
            <button id="cancelDateTimeBtn"
                class="w-full mt-3 bg-gray-300 text-gray-800 py-3 rounded-lg text-lg font-semibold hover:bg-gray-400 transition duration-300">منسوخ کریں</button>
        </div>
    </div>

    <script>
        // Language Data
        const translations = {
            ur: {
                dir: 'rtl',
                appTitle: 'حنفی طہارت ٹریکر',
                historyButtonText: 'سائیکل ہسٹری',
                dashboardTitle: 'ڈیش بورڈ',
                dashboardInfo: 'یہاں آپ کو اپنی موجودہ طہارت کی حیثیت اور اگلے عمل کی رہنمائی ملے گی۔',
                loadingStatus: 'حیثیت لوڈ ہو رہی ہے...',
                habitStatus: 'آپ کی عادت (عادہ): ابھی سیٹ نہیں ہوئی۔',
                habitInfo: 'عادت سے مراد آپ کے حیض اور طہارت کے دنوں کی عام اور مستحکم مدت ہے۔ یہ فقہی احکام کے تعین میں بہت اہم ہے۔',
                mainActionButtonLoading: 'لوڈ ہو رہا ہے...',
                logNifasText: 'نفاس لاگ کریں',

                welcomeModalTitle: 'حنفی طہارت ٹریکر میں خوش آمدید!',
                welcomeQuestion: 'کیا آپ نے پہلے کبھی صحیح حیض کا تجربہ کیا ہے؟',
                welcomeInfo: 'یہ جاننا ضروری ہے کہ آپ نے پہلے حیض کا تجربہ کیا ہے یا نہیں۔ ایک "صحیح حیض" وہ ہے جو کم از کم 3 دن اور زیادہ سے زیادہ 10 دن تک ہو۔',
                mubtadiahBtn: 'نہیں، یہ میرا پہلا موقع ہے۔',
                mutadahBtn: 'ہاں، میری عادت ہے۔',

                habitModalTitle: 'اپنی عادات درج کریں',
                habitInputInfo: 'یہاں اپنی حیض اور طہارت کی عام مدت درج کریں۔ یہ آپ کے فقہی احکام کا تعین کرنے میں مدد کرے گی۔',
                haidhAdahLabel: 'آخری صحیح حیض کی مدت (دن):',
                haidhAdahInfo: 'حیض کی عادت کم از کم 3 دن اور زیادہ سے زیادہ 10 دن تک ہونی چاہیے۔',
                tuhrAdahLabel: 'آخری صحیح طہارت کی مدت (دن):',
                tuhrAdahInfo: 'طہارت کی عادت کم از کم 15 دن ہونی چاہیے۔',
                saveHabitButtonText: 'عادات محفوظ کریں',

                dateTimeModalTitleStart: 'خون آنے کا وقت منتخب کریں',
                dateTimeModalTitleEnd: 'خون بند ہونے کا وقت منتخب کریں',
                dateTimeModalTitleNifasStart: 'نفاس کا آغاز منتخب کریں',
                dateTimeModalTitleNifasEnd: 'نفاس کا اختتام منتخب کریں',
                dateLabel: 'تاریخ:',
                timeLabel: 'وقت:',
                saveButtonText: 'محفوظ کریں',
                cancelButtonText: 'منسوخ کریں',

                currentStatusTuhr: 'موجودہ حیثیت: طہارت (پاکیزگی)۔ آپ نماز اور روزے کی مکلف ہیں۔',
                currentStatusBleeding: (startTime) => `موجودہ حیثیت: خون آنا ${startTime} کو شروع ہوا ہے۔ جب یہ رکے تو اختتامی وقت درج کریں۔`,
                currentStatusNifas: (startTime) => `موجودہ حیثیت: نفاس ${startTime} کو شروع ہوا ہے۔ جب یہ رکے تو اختتامی وقت درج کریں۔`,
                currentStatusUnclear: 'حیثیت غیر واضح ہے۔ براہ کرم اپنے خون آنے کے واقعات درج کریں۔',
                currentStatusPregnant: 'آپ حاملہ ہیں۔ ماہواری اور نفاس کے حساب کتاب کو روک دیا گیا ہے۔',

                logBleedingStart: 'خون آنے کا وقت درج کریں',
                logBleedingEnd: 'خون بند ہونے کا وقت درج کریں',
                startSetup: 'سیٹ اپ شروع کریں',
                yourHabit: (haidhDays, tuhrDays) => `آپ کی عادت (عادہ): ${haidhDays} دن حیض، ${tuhrDays} دن طہارت۔`,
                noHabitEstablished: 'آپ کی عادت (عادہ): ابھی قائم نہیں ہوئی۔',

                cycleHistoryTitle: 'سائیکل ہسٹری',
                noHistory: 'ابھی تک کوئی سائیکل ہسٹری دستیاب نہیں ہے۔',
                backToDashboardButtonText: 'ڈیش بورڈ پر واپس',
                haidhCycleType: 'حیض (ماہواری)',
                istihadahCycleType: 'استحاضہ (غیر ماہواری خون)',
                nifasCycleType: 'نفاس (زچگی کے بعد خون)',
                cycleStart: 'شروع:',
                cycleEnd: 'اختتام:',
                totalDuration: (days, hours) => `کل مدت: ${days} دن (${hours} گھنٹے)`,
                effectiveHaidh: (haidhDays, istihadahDays) => `مؤثر حیض: ${haidhDays} دن۔ استحاضہ: ${istihadahDays} دن۔`,
                effectiveNifas: (nifasDays, istihadahDays) => `مؤثر نفاس: ${nifasDays} دن۔ استحاضہ: ${istihadahDays} دن۔`,
                purityBefore: (days) => `اس سے پہلے کی طہارت: ${days} دن`,
                noteCombinedFlow: 'نوٹ: ناکافی طہارت کی وجہ سے یہ خون پچھلے خون کے ساتھ ملا دیا گیا ہے۔',

                copyrightText: '&copy; 2023 حنفی طہارت ٹریکر۔ تمام حقوق محفوظ ہیں۔',
                disclaimerText: 'یہ ایپلیکیشن ایک مفید ٹول کے طور پر ہے اور حنفی فقہ کے اصولوں پر مبنی ہے۔ یہ کسی مستند اسلامی اسکالر (مفتی) کی رہنمائی کا متبادل نہیں ہے۔ کسی بھی طبی مسئلے کے لیے، براہ کرم صحت کی دیکھ بھال کرنے والے ماہر سے مشورہ کریں۔',
                exportDataButtonText: 'ڈیٹا ایکسپورٹ کریں',
                importDataButtonText: 'ڈیٹا امپورٹ کریں',

                alertHaidhDurationInvalid: 'براہ کرم حیض کی ایک درست مدت (3 اور 10 دن کے درمیان) درج کریں۔',
                alertTuhrDurationInvalid: 'براہ کرم طہارت کی ایک درست مدت (کم از کم 15 دن) درج کریں۔',
                alertSelectDateTime: 'براہ کرم تاریخ اور وقت دونوں منتخب کریں۔',
                alertBleedingBeforeLastHaidhEnd: 'خون پچھلے حیض کے اختتام سے پہلے شروع نہیں ہو سکتا۔',
                alertBleedingStartLogged: 'خون آنے کا وقت کامیابی سے درج کر لیا گیا!',
                alertBleedingStartNotLogged: 'خون آنے کا وقت درج نہیں ہوا۔ براہ کرم پہلے آغاز درج کریں۔',
                alertBleedingEndBeforeStart: 'خون بند ہونے کا وقت شروع ہونے کے وقت سے پہلے نہیں ہو سکتا۔',
                alertCycleCalculated: 'خون بند ہونے کا وقت درج کر لیا گیا اور سائیکل کا حساب لگا لیا گیا!',
                alertExportSuccess: 'ڈیٹا کامیابی سے ایکسپورٹ ہو گیا!',
                alertNoDataToExport: 'ایکسپورٹ کرنے کے لیے کوئی ڈیٹا نہیں ہے۔',
                alertExportError: 'ڈیٹا ایکسپورٹ کرنے میں خرابی۔',
                alertImportSuccess: 'ڈیٹا کامیابی سے امپورٹ ہو گیا! ایپ اب دوبارہ لوڈ ہو گی تاکہ تبدیلیوں کا اطلاق ہو سکے۔',
                alertInvalidImportFile: 'غلط ڈیٹا فائل۔ براہ کرم یقینی بنائیں کہ یہ ایک درست حنفی طہارت ٹریکر بیک اپ JSON ہے۔',
                alertImportError: 'ڈیٹا امپورٹ کرنے میں خرابی۔ غلط JSON فارمیٹ۔',
                alertNifasStartLogged: 'نفاس کا آغاز کامیابی سے درج کر لیا گیا!',
                alertNifasEndBeforeStart: 'نفاس کا اختتام آغاز کے وقت سے پہلے نہیں ہو سکتا۔',
                alertNifasCalculated: 'نفاس کا اختتام درج کر لیا گیا اور اس کا حساب لگا لیا گیا!',
                alertNifasOngoing: 'نفاس پہلے سے ہی جاری ہے۔ اختتامی وقت درج کریں جب یہ رک جائے۔',
            },
            en: {
                dir: 'ltr',
                appTitle: 'Hanafi Purity Tracker',
                historyButtonText: 'Cycle History',
                dashboardTitle: 'Dashboard',
                dashboardInfo: 'Here you will find your current purity status and guidance for the next action.',
                loadingStatus: 'Loading status...',
                habitStatus: 'Your Habit (Adah): Not set yet.',
                habitInfo: 'Adah refers to your typical and stable duration for Haidh (menstruation) and Tuhr (purity). It\'s crucial for determining Fiqhi rulings.',
                mainActionButtonLoading: 'Loading...',
                logNifasText: 'Log Nifas',

                welcomeModalTitle: 'Welcome to Hanafi Purity Tracker!',
                welcomeQuestion: 'Have you experienced a valid menstrual period before?',
                welcomeInfo: 'It\'s important to know if you\'ve experienced menstruation before. A "valid Haidh" is one that lasts at least 3 days and at most 10 days.',
                mubtadiahBtn: 'No, this is my first time.',
                mutadahBtn: 'Yes, I have a habit.',

                habitModalTitle: 'Enter Your Habits',
                habitInputInfo: 'Enter your typical Haidh and Tuhr durations here. This will help determine your Fiqhi rulings.',
                haidhAdahLabel: 'Last valid Haidh duration (days):',
                haidhAdahInfo: 'Haidh (menstruation) habit must be between 3 and 10 days (inclusive).',
                tuhrAdahLabel: 'Last valid Tuhr duration (days):',
                tuhrAdahInfo: 'Tuhr (purity) habit must be at least 15 days.',
                saveHabitButtonText: 'Save Habits',

                dateTimeModalTitleStart: 'Select Bleeding Start Date and Time',
                dateTimeModalTitleEnd: 'Select Bleeding End Date and Time',
                dateTimeModalTitleNifasStart: 'Select Nifas Start Date and Time',
                dateTimeModalTitleNifasEnd: 'Select Nifas End Date and Time',
                dateLabel: 'Date:',
                timeLabel: 'Time:',
                saveButtonText: 'Save',
                cancelButtonText: 'Cancel',

                currentStatusTuhr: 'Current Status: Purity (Tuhr). You are obligated to pray and fast.',
                currentStatusBleeding: (startTime) => `Current Status: Bleeding started on ${startTime}. Log the end time when it stops.`,
                currentStatusNifas: (startTime) => `Current Status: Nifas started on ${startTime}. Log the end time when it stops.`,
                currentStatusUnclear: 'Status unclear. Please log your bleeding events.',
                currentStatusPregnant: 'You are pregnant. Menstrual and Nifas calculations are paused.',

                logBleedingStart: 'Log Bleeding Start',
                logBleedingEnd: 'Log Bleeding End',
                startSetup: 'Start Setup',
                yourHabit: (haidhDays, tuhrDays) => `Your Habit (Adah): ${haidhDays} days of Haidh, ${tuhrDays} days of Tuhr.`,
                noHabitEstablished: 'Your Habit (Adah): Not yet established.',

                cycleHistoryTitle: 'Cycle History',
                noHistory: 'No cycle history available yet.',
                backToDashboardButtonText: 'Back to Dashboard',
                haidhCycleType: 'Menstruation (Haidh)',
                istihadahCycleType: 'Non-menstrual (Istihadah)',
                nifasCycleType: 'Post-natal (Nifas)',
                cycleStart: 'Start:',
                cycleEnd: 'End:',
                totalDuration: (days, hours) => `Total Duration: ${days} days (${hours} hours)`,
                effectiveHaidh: (haidhDays, istihadahDays) => `Effective Haidh: ${haidhDays} days. Istihadah: ${istihadahDays} days.`,
                effectiveNifas: (nifasDays, istihadahDays) => `Effective Nifas: ${nifasDays} days. Istihadah: ${istihadahDays} days.`,
                purityBefore: (days) => `Purity before: ${days} days`,
                noteCombinedFlow: 'Note: This bleeding was combined with previous flow due to insufficient purity.',

                copyrightText: '&copy; 2023 Hanafi Purity Tracker. All rights reserved.',
                disclaimerText: 'This application is intended as a helpful tool and is based on the principles of the Hanafi school of Fiqh. It is not a substitute for guidance from a qualified Islamic scholar (Mufti). For any medical issues, please consult a healthcare professional.',
                exportDataButtonText: 'Export Data',
                importDataButtonText: 'Import Data',

                alertHaidhDurationInvalid: 'Please enter a valid Haidh duration between 3 and 10 days.',
                alertTuhrDurationInvalid: 'Please enter a valid Tuhr duration (minimum 15 days).',
                alertSelectDateTime: 'Please select both date and time.',
                alertBleedingBeforeLastHaidhEnd: 'Bleeding cannot start before the end of the last Haidh period if purity was less than 15 days.',
                alertBleedingStartLogged: 'Bleeding start logged successfully!',
                alertBleedingStartNotLogged: 'Bleeding start time not logged. Please log start first.',
                alertBleedingEndBeforeStart: 'Bleeding end time cannot be before start time.',
                alertCycleCalculated: 'Bleeding end logged and cycle calculated!',
                alertExportSuccess: 'Data exported successfully!',
                alertNoDataToExport: 'No data to export.',
                alertExportError: 'Error exporting data.',
                alertImportSuccess: 'Data imported successfully! App will now reload to apply changes.',
                alertInvalidImportFile: 'Invalid data file. Please ensure it is a valid Hanafi Purity Tracker backup JSON.',
                alertImportError: 'Error importing data. Invalid JSON format.',
                alertNifasStartLogged: 'Nifas start logged successfully!',
                alertNifasEndBeforeStart: 'Nifas end time cannot be before start time.',
                alertNifasCalculated: 'Nifas end logged and calculated!',
                alertNifasOngoing: 'Nifas is already ongoing. Log the end time when it stops.',
            }
        };

        let currentLang = 'ur';
        let currentMode = 'haidh'; // 'haidh' or 'nifas'

        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = translations[lang].dir;

            // Update all elements with dynamic IDs or specific class/attribute for text
            document.getElementById('appTitle').textContent = translations[lang].appTitle;
            document.getElementById('historyBtn').textContent = translations[lang].historyButtonText;
            document.getElementById('dashboardTitle').childNodes[0].nodeValue = translations[lang].dashboardTitle; // To exclude info icon
            document.getElementById('dashboardInfo').textContent = translations[lang].dashboardInfo;
            document.getElementById('loadingStatus').textContent = translations[lang].loadingStatus;
            document.getElementById('habitStatus').textContent = translations[lang].habitStatus;
            document.getElementById('habitInfo').textContent = translations[lang].habitInfo;
            document.getElementById('mainActionButton').textContent = translations[lang].mainActionButtonLoading;
            document.getElementById('logNifasBtn').textContent = translations[lang].logNifasText;

            document.getElementById('welcomeModalTitle').textContent = translations[lang].welcomeModalTitle;
            document.getElementById('welcomeQuestion').childNodes[0].nodeValue = translations[lang].welcomeQuestion; // To exclude info icon
            document.getElementById('welcomeInfo').textContent = translations[lang].welcomeInfo;
            document.getElementById('mubtadiahBtn').textContent = translations[lang].mubtadiahBtn;
            document.getElementById('mutadahBtn').textContent = translations[lang].mutadahBtn;

            document.getElementById('habitModalTitle').childNodes[0].nodeValue = translations[lang].habitModalTitle; // To exclude info icon
            document.getElementById('habitInputInfo').textContent = translations[lang].habitInputInfo;
            document.getElementById('haidhAdahLabel').childNodes[0].nodeValue = translations[lang].haidhAdahLabel; // To exclude info icon
            document.getElementById('haidhAdahInfo').textContent = translations[lang].haidhAdahInfo;
            document.getElementById('tuhrAdahLabel').childNodes[0].nodeValue = translations[lang].tuhrAdahLabel; // To exclude info icon
            document.getElementById('tuhrAdahInfo').textContent = translations[lang].tuhrAdahInfo;
            document.getElementById('saveMutadahHabitBtn').textContent = translations[lang].saveHabitButtonText;

            // DateTime Modal titles are dynamic based on action, handle that in respective functions
            document.getElementById('dateLabel').textContent = translations[lang].dateLabel;
            document.getElementById('timeLabel').textContent = translations[lang].timeLabel;
            document.getElementById('saveDateTimeBtn').textContent = translations[lang].saveButtonText;
            document.getElementById('cancelDateTimeBtn').textContent = translations[lang].cancelButtonText;

            document.getElementById('cycleHistoryTitle').textContent = translations[lang].cycleHistoryTitle;
            document.getElementById('noHistory').textContent = translations[lang].noHistory;
            document.getElementById('backToDashboardBtn').textContent = translations[lang].backToDashboardButtonText;
            document.getElementById('copyrightText').innerHTML = translations[lang].copyrightText; // Use .innerHTML for the © symbol
            document.getElementById('disclaimerText').textContent = translations[lang].disclaimerText;
            document.getElementById('exportDataBtn').textContent = translations[lang].exportDataButtonText;
            document.getElementById('importDataBtn').textContent = translations[lang].importDataButtonText;


            // Set direction for date/time pickers
            const datePicker = document.getElementById('datePicker');
            const timePicker = document.getElementById('timePicker');
            if (datePicker) datePicker.style.direction = translations[currentLang].dir;
            if (timePicker) timePicker.style.direction = translations[currentLang].dir;
            if (haidhAdahDaysInput) haidhAdahDaysInput.style.direction = translations[currentLang].dir;
            if (tuhrAdahDaysInput) tuhrAdahDaysInput.style.direction = translations[currentLang].dir;

            updateDashboardUI(); // Refresh dashboard to apply language changes to dynamic text
            renderCycleHistory(); // Refresh history to apply language changes
        }

        // IndexedDB Constants
        const DB_NAME = 'HanafiPurityDB';
        const STORE_NAME = 'userProfile';
        const DB_VERSION = 2; // Incremented version for new structure

        // Fiqh Constants (in hours)
        const HAIDH_MIN = 72; // 3 days
        const HAIDH_MAX = 240; // 10 days
        const TUHR_MIN = 360; // 15 days
        const NIFAS_MAX = 960; // 40 days

        // Global user profile object
        let userProfile = {
            id: 1,
            userType: null, // 'mubtadiah' (beginner) or 'mutadah' (habitual)
            haidhAdahHours: 0, // Habit for Haidh in hours
            tuhrAdahHours: 0, // Habit for Tuhr in hours
            currentState: 'tuhr', // 'tuhr', 'bleeding', 'haidh', 'istihadah', 'nifas_bleeding', 'nifas_purity'
            lastHaidhEnd: null, // Timestamp of the end of the last valid Haidh
            lastNifasEnd: null, // Timestamp of the end of the last valid Nifas
            currentBleedingStart: null, // Timestamp for the current bleeding episode (haidh/istihadah)
            currentNifasStart: null, // Timestamp for the current nifas episode
            cycleHistory: [], // An array of all past cycle objects (haidh, istihadah, nifas)
            isPregnant: false, // New field for pregnancy status
            ageInLunarYears: 0, // Placeholder for age, advanced rulings would use this
        };

        // DOM Elements
        const langToggleBtn = document.getElementById('langToggleBtn');
        const welcomeModal = document.getElementById('welcomeModal');
        const mubtadiahBtn = document.getElementById('mubtadiahBtn');
        const mutadahBtn = document.getElementById('mutadahBtn');
        const mutadahHabitModal = document.getElementById('mutadahHabitModal');
        const haidhAdahDaysInput = document.getElementById('haidhAdahDays');
        const tuhrAdahDaysInput = document.getElementById('tuhrAdahDays');
        const saveMutadahHabitBtn = document.getElementById('saveMutadahHabitBtn');
        const statusDisplay = document.getElementById('statusDisplay');
        const habitDisplay = document.getElementById('habitDisplay');
        const mainActionButton = document.getElementById('mainActionButton');
        const logNifasBtn = document.getElementById('logNifasBtn');
        const dateTimeModal = document.getElementById('dateTimeModal');
        const dateTimeModalTitle = document.getElementById('dateTimeModalTitle');
        const datePicker = document.getElementById('datePicker');
        const timePicker = document.getElementById('timePicker');
        const saveDateTimeBtn = document.getElementById('saveDateTimeBtn');
        const cancelDateTimeBtn = document.getElementById('cancelDateTimeBtn');
        const historyBtn = document.getElementById('historyBtn');
        const cycleHistorySection = document.getElementById('cycleHistorySection');
        const historyList = document.getElementById('historyList');
        const backToDashboardBtn = document.getElementById('backToDashboardBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataInput = document.getElementById('importDataInput');
        const importDataBtn = document.getElementById('importDataBtn');

        // IndexedDB Functions
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                    // Add new fields if upgrading from an older version
                    const store = request.transaction.objectStore(STORE_NAME);
                    // Example of adding index (not strictly needed for this simple profile object)
                    // if (!store.indexNames.contains('lastHaidhEnd')) {
                    //     store.createIndex('lastHaidhEnd', 'lastHaidhEnd', { unique: false });
                    // }
                };

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        async function getProfile() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(1);

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    console.error("Error getting profile:", event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        async function saveProfile(profile) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(profile);

                request.onsuccess = () => {
                    resolve();
                };

                request.onerror = (event) => {
                    console.error("Error saving profile:", event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        // Utility Functions
        function hoursToDays(hours) {
            return (hours / 24).toFixed(1);
        }

        function daysToHours(days) {
            return days * 24;
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString(currentLang === 'ur' ? 'ur-PK' : 'en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        function calculateDurationInHours(start, end) {
            if (!start || !end) return 0;
            return Math.abs(new Date(end).getTime() - new Date(start).getTime()) / (1000 * 60 * 60);
        }

        // Core Logic
        async function initializeApp() {
            setLanguage(currentLang); // Set initial language
            const savedProfile = await getProfile();

            if (savedProfile) {
                userProfile = { ...userProfile, ...savedProfile }; // Merge saved profile with default to handle new fields
                // Ensure default values for new fields if not present in savedProfile
                userProfile.isPregnant = userProfile.isPregnant === undefined ? false : userProfile.isPregnant;
                userProfile.ageInLunarYears = userProfile.ageInLunarYears === undefined ? 0 : userProfile.ageInLunarYears;
                userProfile.lastNifasEnd = userProfile.lastNifasEnd === undefined ? null : userProfile.lastNifasEnd;
                userProfile.currentNifasStart = userProfile.currentNifasStart === undefined ? null : userProfile.currentNifasStart;

                updateDashboardUI();
            } else {
                // Add sample data on first run if no profile exists
                //await addSampleData();
                const freshProfile = await getProfile(); // Re-fetch after adding samples
                if (freshProfile) {
                    userProfile = { ...userProfile, ...freshProfile };
                    updateDashboardUI();
                } else {
                    welcomeModal.classList.add('open');
                }
            }
            mainActionButton.disabled = false; // Enable button after initialization attempt
        }

        async function setupMubtadiah() {
            userProfile.userType = 'mubtadiah';
            await saveProfile(userProfile);
            welcomeModal.classList.remove('open');
            updateDashboardUI();
        }

        async function setupMutadah() {
            welcomeModal.classList.remove('open');
            mutadahHabitModal.classList.add('open');
        }

        async function saveMutadahHabit() {
            const haidhDays = parseFloat(haidhAdahDaysInput.value);
            const tuhrDays = parseFloat(tuhrAdahDaysInput.value);

            if (isNaN(haidhDays) || haidhDays < 3 || haidhDays > 10) {
                alert(translations[currentLang].alertHaidhDurationInvalid);
                return;
            }
            if (isNaN(tuhrDays) || tuhrDays < 15) {
                alert(translations[currentLang].alertTuhrDurationInvalid);
                return;
            }

            userProfile.userType = 'mutadah';
            userProfile.haidhAdahHours = daysToHours(haidhDays);
            userProfile.tuhrAdahHours = daysToHours(tuhrDays);
            await saveProfile(userProfile);
            mutadahHabitModal.classList.remove('open');
            updateDashboardUI();
        }

        // Handles both Haidh/Istihadah and Nifas logging
        async function logBleedingStartPrompt(mode = 'haidh') {
            currentMode = mode; // Set global mode for save action
            if (mode === 'haidh') {
                dateTimeModalTitle.textContent = translations[currentLang].dateTimeModalTitleStart;
            } else {
                dateTimeModalTitle.textContent = translations[currentLang].dateTimeModalTitleNifasStart;
            }

            datePicker.valueAsDate = new Date();
            timePicker.value = new Date().toTimeString().slice(0, 5);
            dateTimeModal.dataset.action = 'start';
            dateTimeModal.classList.add('open');
        }

        async function logBleedingEndPrompt(mode = 'haidh') {
            currentMode = mode; // Set global mode for save action
            if (mode === 'haidh') {
                dateTimeModalTitle.textContent = translations[currentLang].dateTimeModalTitleEnd;
            } else {
                dateTimeModalTitle.textContent = translations[currentLang].dateTimeModalTitleNifasEnd;
            }
            datePicker.valueAsDate = new Date();
            timePicker.value = new Date().toTimeString().slice(0, 5);
            dateTimeModal.dataset.action = 'end';
            dateTimeModal.classList.add('open');
        }

        async function handleDateTimeSave() {
            const selectedDate = datePicker.value;
            const selectedTime = timePicker.value;

            if (!selectedDate || !selectedTime) {
                alert(translations[currentLang].alertSelectDateTime);
                return;
            }

            const timestamp = new Date(`${selectedDate}T${selectedTime}`).getTime();

            if (dateTimeModal.dataset.action === 'start') {
                if (currentMode === 'haidh') {
                    // Check for Tuhr Fasid (purity less than 15 days) and combine flows
                    const lastCycle = userProfile.cycleHistory[0];
                    if (lastCycle && lastCycle.type === 'haidh' && userProfile.lastHaidhEnd && calculateDurationInHours(userProfile.lastHaidhEnd, timestamp) < TUHR_MIN) {
                        // This indicates a possible Tuhr Fasid, combine with the previous bleeding
                        // This is a simplification: in true fiqh, the entire period from previous haidh start to current bleeding end would be recalculated.
                        // For a single-file app, we mark this as a combined flow and let the user re-evaluate if it's too complex.
                        userProfile.currentBleedingStart = lastCycle.startDate; // Effectively combine
                        userProfile.currentState = 'bleeding';
                        await saveProfile(userProfile);
                        alert(translations[currentLang].alertBleedingStartLogged + "\n" + translations[currentLang].noteCombinedFlow);
                    } else {
                        userProfile.currentBleedingStart = timestamp;
                        userProfile.currentState = 'bleeding';
                        await saveProfile(userProfile);
                        alert(translations[currentLang].alertBleedingStartLogged);
                    }
                } else { // Nifas mode
                    if (userProfile.currentNifasStart) {
                        alert(translations[currentLang].alertNifasOngoing);
                        return;
                    }
                    userProfile.currentNifasStart = timestamp;
                    userProfile.currentState = 'nifas_bleeding';
                    await saveProfile(userProfile);
                    alert(translations[currentLang].alertNifasStartLogged);
                }
            } else if (dateTimeModal.dataset.action === 'end') {
                if (currentMode === 'haidh') {
                    if (!userProfile.currentBleedingStart) {
                        alert(translations[currentLang].alertBleedingStartNotLogged);
                        return;
                    }
                    if (timestamp < userProfile.currentBleedingStart) {
                        alert(translations[currentLang].alertBleedingEndBeforeStart);
                        return;
                    }

                    await calculateHaidhCycle(timestamp);
                    alert(translations[currentLang].alertCycleCalculated);
                } else { // Nifas mode
                    if (!userProfile.currentNifasStart) {
                        alert(translations[currentLang].alertBleedingStartNotLogged); // Re-using this alert, could be more specific
                        return;
                    }
                    if (timestamp < userProfile.currentNifasStart) {
                        alert(translations[currentLang].alertNifasEndBeforeStart);
                        return;
                    }
                    await calculateNifasCycle(timestamp);
                    alert(translations[currentLang].alertNifasCalculated);
                }
            }

            dateTimeModal.classList.remove('open');
            updateDashboardUI();
        }

        async function calculateHaidhCycle(bleedingEndTimestamp) {
            const bleedingStart = userProfile.currentBleedingStart;
            const totalBleedingDuration = calculateDurationInHours(bleedingStart, bleedingEndTimestamp);
            let cycleType = 'istihadah';
            let effectiveHaidhHours = 0;
            let tuhrDurationSinceLastHaidh = userProfile.lastHaidhEnd ? calculateDurationInHours(userProfile.lastHaidhEnd, bleedingStart) : 0;

            // Fiqh Rule 1: Bleeding less than 3 days (HAIDH_MIN) is Istihadah
            if (totalBleedingDuration < HAIDH_MIN) {
                cycleType = 'istihadah';
            }
            // Fiqh Rule 2: Bleeding starts before minimum purity (TUHR_MIN)
            else if (tuhrDurationSinceLastHaidh < TUHR_MIN && userProfile.lastHaidhEnd !== null) {
                // This scenario means previous haidh and current bleeding are separated by less than 15 days purity
                // Hanafi Fiqh: combine with previous flow. For simplicity here, we mark this as istihadah if it's not a clear haidh after proper tuhr.
                // A more advanced app would merge the cycles and recalculate.
                // For this single-file app, if it's less than min tuhr, it's istihadah unless it's a mubtadiah's first haidh.
                cycleType = 'istihadah';
            }
            // Fiqh Rule 3: Bleeding between 3 and 10 days (HAIDH_MIN to HAIDH_MAX)
            else if (totalBleedingDuration >= HAIDH_MIN && totalBleedingDuration <= HAIDH_MAX) {
                cycleType = 'haidh';
                effectiveHaidhHours = totalBleedingDuration;
                userProfile.lastHaidhEnd = bleedingEndTimestamp;

                // Update Haidh Adah if user is mutadah or mubtadiah establishes first habit
                if (userProfile.userType === 'mutadah' || (userProfile.userType === 'mubtadiah' && userProfile.haidhAdahHours === 0)) {
                    userProfile.haidhAdahHours = effectiveHaidhHours;
                    // Update Tuhr Adah from the purity period leading up to this Haidh
                    if (tuhrDurationSinceLastHaidh >= TUHR_MIN || (userProfile.userType === 'mubtadiah' && userProfile.tuhrAdahHours === 0)) {
                        userProfile.tuhrAdahHours = tuhrDurationSinceLastHaidh === 0 ? TUHR_MIN : tuhrDurationSinceLastHaidh; // Default to 15 days for first if no prior
                    }
                }
            }
            // Fiqh Rule 4: Bleeding exceeds 10 days (HAIDH_MAX)
            else if (totalBleedingDuration > HAIDH_MAX) {
                if (userProfile.userType === 'mubtadiah' && userProfile.haidhAdahHours === 0) {
                    // Mubtadiah's first bleeding, exceeding 10 days: First 10 days are Haidh, rest Istihadah.
                    effectiveHaidhHours = HAIDH_MAX;
                    cycleType = 'haidh'; // The first 10 days are haidh
                    userProfile.lastHaidhEnd = bleedingStart + (effectiveHaidhHours * 60 * 60 * 1000);
                    userProfile.haidhAdahHours = effectiveHaidhHours; // Establishes her first habit
                    userProfile.tuhrAdahHours = TUHR_MIN; // Establishes her first tuhr habit as minimal
                } else if (userProfile.userType === 'mutadah' && userProfile.haidhAdahHours > 0) {
                    // Mutadah with an established habit: Haidh is up to her habit, rest is Istihadah
                    effectiveHaidhHours = userProfile.haidhAdahHours;
                    cycleType = 'haidh'; // The initial part is haidh
                    userProfile.lastHaidhEnd = bleedingStart + (effectiveHaidhHours * 60 * 60 * 1000);
                } else {
                    // This scenario means an established mutadah with changing habits, or other complex cases.
                    // For this simplified app, if no clear habit or it's not the first haidh exceeding 10,
                    // it defaults to istihadah in its entirety. A mufti would be consulted here.
                    cycleType = 'istihadah';
                    effectiveHaidhHours = 0;
                }
            }

            userProfile.cycleHistory.unshift({ // Add to the beginning of the array
                startDate: bleedingStart,
                endDate: bleedingEndTimestamp,
                durationHours: totalBleedingDuration,
                type: cycleType,
                effectiveHaidhHours: effectiveHaidhHours,
                tuhrDurationBefore: tuhrDurationSinceLastHaidh,
                isCombinedFlow: (tuhrDurationSinceLastHaidh < TUHR_MIN && userProfile.lastHaidhEnd !== null && cycleType === 'istihadah') // Indicate if it was considered combined
            });

            // Update currentState and reset currentBleedingStart
            userProfile.currentState = 'tuhr';
            userProfile.currentBleedingStart = null;
            await saveProfile(userProfile);
        }

        async function calculateNifasCycle(nifasEndTimestamp) {
            const nifasStart = userProfile.currentNifasStart;
            const totalNifasDuration = calculateDurationInHours(nifasStart, nifasEndTimestamp);
            let effectiveNifasHours = 0;
            let cycleType = 'nifas';

            if (totalNifasDuration <= NIFAS_MAX) {
                effectiveNifasHours = totalNifasDuration;
                userProfile.lastNifasEnd = nifasEndTimestamp;
            } else {
                // Exceeds 40 days: Nifas is 40 days, rest is Istihadah
                effectiveNifasHours = NIFAS_MAX;
                userProfile.lastNifasEnd = nifasStart + (NIFAS_MAX * 60 * 60 * 1000);
            }

            userProfile.cycleHistory.unshift({
                startDate: nifasStart,
                endDate: nifasEndTimestamp,
                durationHours: totalNifasDuration,
                type: 'nifas',
                effectiveNifasHours: effectiveNifasHours,
                // Nifas doesn't have "purity before" in the same way haidh does for cycle calculation
            });

            userProfile.currentState = 'tuhr'; // After Nifas, it's Tuhr
            userProfile.currentNifasStart = null;
            await saveProfile(userProfile);
        }


        function updateDashboardUI() {
            let statusMessage = translations[currentLang].loadingStatus;
            let statusClass = "bg-gray-50 text-gray-800 border-gray-500"; // Default neutral
            let buttonText = translations[currentLang].mainActionButtonLoading;
            let buttonClass = "bg-gray-400 cursor-not-allowed"; // Default disabled

            logNifasBtn.classList.add('hidden'); // Hide Nifas button by default

            if (userProfile.isPregnant) {
                statusMessage = translations[currentLang].currentStatusPregnant;
                statusClass = "bg-blue-50 text-blue-800 border-r-4 border-blue-500";
                mainActionButton.textContent = "حمل لاگ کریں (جلد آرہا ہے)"; // Placeholder
                mainActionButton.disabled = true;
            } else if (!userProfile.userType) {
                statusMessage = translations[currentLang].loadingStatus; // Should be replaced by setup process
                buttonText = translations[currentLang].startSetup;
                mainActionButton.onclick = () => welcomeModal.classList.add('open');
                mainActionButton.disabled = false;
            } else {
                switch (userProfile.currentState) {
                    case 'tuhr':
                        statusMessage = translations[currentLang].currentStatusTuhr;
                        statusClass = "bg-green-50 text-green-800 border-r-4 border-green-500";
                        buttonText = translations[currentLang].logBleedingStart;
                        buttonClass = "bg-green-600 hover:bg-green-700";
                        mainActionButton.onclick = () => logBleedingStartPrompt('haidh');
                        mainActionButton.disabled = false;
                        logNifasBtn.classList.remove('hidden'); // Show Nifas button when in Tuhr
                        logNifasBtn.onclick = () => logBleedingStartPrompt('nifas');
                        break;
                    case 'bleeding':
                        const startTimeBleeding = formatDateTime(userProfile.currentBleedingStart);
                        statusMessage = translations[currentLang].currentStatusBleeding(startTimeBleeding);
                        statusClass = "bg-yellow-50 text-yellow-800 border-r-4 border-yellow-500";
                        buttonText = translations[currentLang].logBleedingEnd;
                        buttonClass = "bg-red-600 hover:bg-red-700";
                        mainActionButton.onclick = () => logBleedingEndPrompt('haidh');
                        mainActionButton.disabled = false;
                        break;
                    case 'nifas_bleeding':
                        const startTimeNifas = formatDateTime(userProfile.currentNifasStart);
                        statusMessage = translations[currentLang].currentStatusNifas(startTimeNifas);
                        statusClass = "bg-purple-50 text-purple-800 border-r-4 border-purple-500";
                        buttonText = translations[currentLang].logBleedingEnd; // Re-using for Nifas end
                        buttonClass = "bg-purple-600 hover:bg-purple-700";
                        mainActionButton.onclick = () => logBleedingEndPrompt('nifas');
                        mainActionButton.disabled = false;
                        break;
                    default:
                        statusMessage = translations[currentLang].currentStatusUnclear;
                        statusClass = "bg-gray-50 text-gray-800 border-r-4 border-gray-500";
                        buttonText = translations[currentLang].logBleedingStart;
                        buttonClass = "bg-green-600 hover:bg-green-700";
                        mainActionButton.onclick = () => logBleedingStartPrompt('haidh');
                        mainActionButton.disabled = false;
                        break;
                }
            }

            statusDisplay.innerHTML = `<p>${statusMessage}</p>`;
            statusDisplay.className = `mb-6 p-4 rounded-md text-lg ${statusClass}`;
            mainActionButton.textContent = buttonText;
            mainActionButton.className = `w-full text-white py-3 rounded-lg text-xl font-bold transition duration-300 ease-in-out ${buttonClass}`;

            // Update habit display
            if (userProfile.userType === 'mutadah' || (userProfile.userType === 'mubtadiah' && userProfile.haidhAdahHours > 0)) {
                habitDisplay.innerHTML = `<p id="habitStatus">${translations[currentLang].yourHabit(hoursToDays(userProfile.haidhAdahHours), hoursToDays(userProfile.tuhrAdahHours))}</p>
                <span class="info-box mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-gray-700"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="info-box-content" id="habitInfo"></span>
                </span>`;
            } else {
                habitDisplay.innerHTML = `<p id="habitStatus">${translations[currentLang].noHabitEstablished}</p>
                <span class="info-box mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-gray-700"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="info-box-content" id="habitInfo"></span>
                </span>`;
            }
            // Re-apply habitInfo content after re-rendering to ensure it's up-to-date
            document.getElementById('habitInfo').textContent = translations[currentLang].habitInfo;
        }

        function renderCycleHistory() {
            historyList.innerHTML = ''; // Clear previous entries
            if (userProfile.cycleHistory.length === 0) {
                historyList.innerHTML = `<p class="text-gray-600">${translations[currentLang].noHistory}</p>`;
                return;
            }

            userProfile.cycleHistory.forEach((cycle, index) => {
                const cycleDiv = document.createElement('div');
                let cardClass = '';
                let typeText = '';
                let durationDetails = '';
                let purityBeforeText = cycle.tuhrDurationBefore !== undefined ? `<p><strong>${translations[currentLang].purityBefore(hoursToDays(cycle.tuhrDurationBefore))}</strong></p>` : '';
                let noteText = cycle.isCombinedFlow ? `<p class="text-red-700"><strong>${translations[currentLang].noteCombinedFlow}</strong></p>` : '';

                switch (cycle.type) {
                    case 'haidh':
                        cardClass = 'bg-red-50 border-r-4 border-red-500';
                        typeText = translations[currentLang].haidhCycleType;
                        let haidhDays = hoursToDays(cycle.effectiveHaidhHours);
                        let istihadahDaysHaidh = hoursToDays(cycle.durationHours - cycle.effectiveHaidhHours);
                        durationDetails = translations[currentLang].effectiveHaidh(haidhDays, istihadahDaysHaidh);
                        break;
                    case 'istihadah':
                        cardClass = 'bg-blue-50 border-r-4 border-blue-500';
                        typeText = translations[currentLang].istihadahCycleType;
                        durationDetails = translations[currentLang].totalDuration(hoursToDays(cycle.durationHours), cycle.durationHours.toFixed(1));
                        break;
                    case 'nifas':
                        cardClass = 'bg-purple-50 border-r-4 border-purple-500';
                        typeText = translations[currentLang].nifasCycleType;
                        let nifasDays = hoursToDays(cycle.effectiveNifasHours);
                        let istihadahDaysNifas = hoursToDays(cycle.durationHours - cycle.effectiveNifasHours);
                        durationDetails = translations[currentLang].effectiveNifas(nifasDays, istihadahDaysNifas);
                        purityBeforeText = ''; // Not applicable for Nifas
                        break;
                }

                cycleDiv.className = `p-4 rounded-lg shadow-md ${cardClass}`;
                cycleDiv.innerHTML = `
                    <p class="text-lg font-semibold mb-1">${typeText}</p>
                    <p><strong>${translations[currentLang].cycleStart}</strong> ${formatDateTime(cycle.startDate)}</p>
                    <p><strong>${translations[currentLang].cycleEnd}</strong> ${formatDateTime(cycle.endDate)}</p>
                    <p>${durationDetails}</p>
                    ${purityBeforeText}
                    ${noteText}
                `;
                historyList.appendChild(cycleDiv);
            });
        }

        function showHistoryPage() {
            document.getElementById('dashboard').classList.add('hidden');
            cycleHistorySection.classList.remove('hidden');
            renderCycleHistory();
        }

        function showDashboardPage() {
            document.getElementById('dashboard').classList.remove('hidden');
            cycleHistorySection.classList.add('hidden');
            updateDashboardUI(); // Refresh dashboard in case history was viewed
        }

        // Event Listeners
        langToggleBtn.addEventListener('click', () => {
            setLanguage(currentLang === 'ur' ? 'en' : 'ur');
        });
        mubtadiahBtn.addEventListener('click', setupMubtadiah);
        mutadahBtn.addEventListener('click', setupMutadah);
        saveMutadahHabitBtn.addEventListener('click', saveMutadahHabit);
        saveDateTimeBtn.addEventListener('click', handleDateTimeSave);
        cancelDateTimeBtn.addEventListener('click', () => dateTimeModal.classList.remove('open'));
        historyBtn.addEventListener('click', showHistoryPage);
        backToDashboardBtn.addEventListener('click', showDashboardPage);

        // Data Backup & Restore
        async function exportData() {
            const db = await openDB();
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(1);

            request.onsuccess = () => {
                const data = request.result;
                if (data) {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `hanafi_purity_tracker_backup_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert(translations[currentLang].alertExportSuccess);
                } else {
                    alert(translations[currentLang].alertNoDataToExport);
                }
            };

            request.onerror = (event) => {
                console.error('Error exporting data:', event.target.errorCode);
                alert(translations[currentLang].alertExportError);
            };
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedProfile = JSON.parse(e.target.result);
                    // Basic validation to ensure it's a valid profile object
                    if (importedProfile && importedProfile.id === 1 && Array.isArray(importedProfile.cycleHistory)) {
                        await saveProfile(importedProfile);
                        userProfile = { ...userProfile, ...importedProfile }; // Update global profile with imported data
                        alert(translations[currentLang].alertImportSuccess);
                        window.location.reload(); // Reload to reflect new data
                    } else {
                        alert(translations[currentLang].alertInvalidImportFile);
                    }
                } catch (error) {
                    console.error('Error parsing imported data:', error);
                    alert(translations[currentLang].alertImportError);
                }
            };
            reader.readAsText(file);
        }

        exportDataBtn.addEventListener('click', exportData);
        importDataBtn.addEventListener('click', () => importDataInput.click());
        importDataInput.addEventListener('change', importData);

        // Sample Data for initial population (exactly four entries)
        async function addSampleData() {
            const existingProfile = await getProfile();
            if (existingProfile && existingProfile.userType) {
                // If a profile already exists, do not add sample data
                return;
            }

            userProfile = {
                id: 1,
                userType: 'mutadah',
                haidhAdahHours: daysToHours(7), // Initial habit for sample
                tuhrAdahHours: daysToHours(20), // Initial habit for sample
                currentState: 'tuhr',
                lastHaidhEnd: null,
                lastNifasEnd: null,
                currentBleedingStart: null,
                currentNifasStart: null,
                cycleHistory: [],
                isPregnant: false,
                ageInLunarYears: 0,
            };

            const now = Date.now();
            const oneDay = 1000 * 60 * 60 * 24;

            // Sample 1: Normal Haidh (7 days) after a long Tuhr (25 days)
            let haidh1End = now - (oneDay * 30); // Ended 30 days ago
            let haidh1Start = haidh1End - (oneDay * 7); // Lasted 7 days
            userProfile.cycleHistory.unshift({
                startDate: haidh1Start,
                endDate: haidh1End,
                durationHours: daysToHours(7),
                type: 'haidh',
                effectiveHaidhHours: daysToHours(7),
                tuhrDurationBefore: daysToHours(25), // Assumed purity before this cycle
                isCombinedFlow: false
            });
            userProfile.lastHaidhEnd = haidh1End;
            userProfile.haidhAdahHours = daysToHours(7);
            userProfile.tuhrAdahHours = daysToHours(25); // Update tuhr adah from this valid purity

            // Sample 2: Istihadah (too short, 2 days) after valid Tuhr (15 days)
            let istihadah2Start = userProfile.lastHaidhEnd + (oneDay * 15);
            let istihadah2End = istihadah2Start + (oneDay * 2);
            userProfile.cycleHistory.unshift({
                startDate: istihadah2Start,
                endDate: istihadah2End,
                durationHours: daysToHours(2),
                type: 'istihadah',
                effectiveHaidhHours: 0,
                tuhrDurationBefore: daysToHours(15),
                isCombinedFlow: false
            });
            // lastHaidhEnd remains unchanged as this was Istihadah

            // Sample 3: Haidh exceeding 10 days (12 days) for a Mutadah with 7-day habit.
            // First 7 days are Haidh, remaining 5 days are Istihadah.
            let bleeding3Start = userProfile.lastHaidhEnd + (oneDay * 20); // 20 days purity after last haidh
            let bleeding3End = bleeding3Start + (oneDay * 12); // Bleeds for 12 days
            userProfile.cycleHistory.unshift({
                startDate: bleeding3Start,
                endDate: bleeding3End,
                durationHours: daysToHours(12),
                type: 'haidh', // Primary type is haidh, but effective haidh is limited
                effectiveHaidhHours: daysToHours(7), // Limited by habit
                tuhrDurationBefore: daysToHours(20),
                isCombinedFlow: false
            });
            userProfile.lastHaidhEnd = bleeding3Start + daysToHours(7); // Haidh effectively ends at habit mark
            userProfile.tuhrAdahHours = daysToHours(20); // Update tuhr adah from this purity

            // Sample 4: Nifas (30 days)
            let nifasStart = now - (oneDay * 60); // Nifas started 60 days ago
            let nifasEnd = nifasStart + (oneDay * 30); // Lasted 30 days
            userProfile.cycleHistory.unshift({
                startDate: nifasStart,
                endDate: nifasEnd,
                durationHours: daysToHours(30),
                type: 'nifas',
                effectiveNifasHours: daysToHours(30),
                tuhrDurationBefore: 0, // Not applicable for Nifas
                isCombinedFlow: false
            });
            userProfile.lastNifasEnd = nifasEnd;

            await saveProfile(userProfile);
        }

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>

</html>